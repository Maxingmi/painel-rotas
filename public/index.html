<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-g">
    <title>Painel de Rotas</title>
    <style> /* ... SEU CSS COMPLETO AQUI ... */ </style>
</head>
<body>
    <div id="historico"><h3>Anunciadas</h3><ul id="lista-historico"></ul></div>
    <div id="painel-principal"><div id="rota">--</div><div id="horario">--</div><div id="contagem-regressiva"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const rotaEl = document.getElementById('rota');
        const horarioEl = document.getElementById('horario');
        const listaHistoricoEl = document.getElementById('lista-historico');
        const contagemEl = document.getElementById('contagem-regressiva');
        const painelPrincipalEl = document.getElementById('painel-principal');
        const VINTE_MINUTOS_EM_MS = 20 * 60 * 1000;

        let cronometroLocal = null; // Variável para controlar nosso cronômetro

        function formatarTempo(ms) {
            // Sua função formatarTempo continua a mesma
        }

        socket.on('atualizar-painel', (dados) => {
            console.log("Recebi novos dados do servidor:", dados);

            // Limpa qualquer cronômetro antigo
            if (cronometroLocal) clearInterval(cronometroLocal);

            // 1. Atualiza o painel principal
            const proxima = dados.proxima;
            rotaEl.textContent = proxima.nome;
            horarioEl.textContent = proxima.horario;

            // 2. Atualiza a lista de histórico
            listaHistoricoEl.innerHTML = '';
            const passadas = dados.passadas;
            passadas.forEach(rota => { /* ... sua lógica para preencher o histórico ... */ });

            // 3. Inicia a nova contagem regressiva local
            let contagemMs = dados.contagemRegressiva;
            if (contagemMs !== null && contagemMs > 0) {
                cronometroLocal = setInterval(() => {
                    contagemEl.textContent = formatarTempo(contagemMs);

                    if (contagemMs <= VINTE_MINUTOS_EM_MS) {
                        painelPrincipalEl.classList.add('alerta-piscando');
                    } else {
                        painelPrincipalEl.classList.remove('alerta-piscando');
                    }
                    
                    if (contagemMs <= 0) {
                        clearInterval(cronometroLocal);
                        console.log("Cronômetro zerou! Pedindo nova rota ao servidor...");
                        socket.emit('preciso-de-nova-rota'); // Pede a próxima rota!
                    }

                    contagemMs -= 1000; // Decrementa 1 segundo
                }, 1000);
            } else {
                contagemEl.textContent = '';
                painelPrincipalEl.classList.remove('alerta-piscando');
            }
        });
    </script>
</body>
</html>